# Template file for 'libreoffice-dictionaries'
pkgname=libreoffice-dictionaries
version=25.8.3.2
revision=1
metapackage=yes
hostmakedepends="mythes perl"
short_desc="Libre Office Dictionaries"
maintainer="Đoàn Trần Công Danh <congdanhqx@gmail.com>"
license="GPL-3.0-or-later"
homepage="https://www.libreoffice.org/"
distfiles="https://download.documentfoundation.org/libreoffice/src/${version%.*}/${pkgname}-${version}.tar.xz"
# distfiles="https://download.nus.edu.sg/mirror/tdf/libreoffice/src/${version%.*}/${pkgname}-${version}.tar.xz"
# distfiles="https://mirrors.nju.edu.cn/tdf/libreoffice/src/${version%.*}/${pkgname}-${version}.tar.xz"
checksum=de30fd10e444fbc0cdb019a560ee70c1af25c393589c6eb26ac1a1e7de4636d5

depends="
 hunspell-en hunspell-no hyphen-en hyphen-no mythes-en mythes-no"

build_options="bdic"
desc_option_bdic="Enable Chromium's bdic format"

_drop_long_dic() {
	local lang="$1"
	local len="$2"
	local dir="${3:-$lang}"
	cp "dictionaries/$dir/$lang.aff" bdic/
	sed "/.\\{$len\\}/d" dictionaries/$dir/$lang.dic >"bdic/$lang.dic"
}

_build_bdic() {
	local file base lang dic
	PATH="/usr/lib/qt6/libexec:/usr/lib/qt5/bin:$PATH"

	mkdir -p bdic
	# convert-dict not understand TAB
	for lang in an_ES bn_BD; do
		sed 's/\t/ /g' "dictionaries/$lang/$lang.aff" >"bdic/$lang.aff"
		cp "dictionaries/$lang/$lang.dic" bdic/
	done

	# convert-dict works on fixed array of utf-16 characters.
	_drop_long_dic da_DK 112
	_drop_long_dic gl_ES 111 gl
	_drop_long_dic gu_IN 45
	_drop_long_dic ko_KR 173
	if [ "$XBPS_WORDSIZE" != 64 ]; then
		_drop_long_dic ta_IN 50
	fi
	_drop_long_dic th_TH 45

	# convert-dict not understand IGNORE
	grep -l IGNORE dictionaries/*/*.aff |
	while read file; do
		lang="${file##*/}"
		lang="${lang%.aff}"
		sed '/^IGNORE/d' "$file" >"bdic/$lang.aff"
		cp "dictionaries/$lang/$lang.dic" bdic/
	done

	find dictionaries -name '*.aff' |
	if [ "$XBPS_WORDSIZE" = 64 ]; then
		cat
	else
		grep -v sa_IN
	fi |
	while read file; do
		base="${file%.aff}"
		lang="${base##*/}"
		echo "converting: $lang"
		if [ -f "bdic/$lang.aff" ]; then
			dic="bdic/$lang.dic"
		else
			dic="${base}.dic"
		fi
		qwebengine_convert_dict "${dic}" "bdic/$lang.bdic"
	done
}

_vbdic() {
	if [ "$build_option_bdic" ]; then
		vmkdir usr/share/hunspell-bdic
		vinstall "bdic/$1.bdic" 0644 usr/share/hunspell-bdic
	fi
}

_vbdiclink() {
	if [ "$build_option_bdic" ]; then
		ln -sf "$1.bdic" "${PKGDESTDIR}/usr/share/hunspell-bdic/$2.bdic"
	fi
}

_vhunspell() {
	local subdir lang lnk
	if [ "$1" = -d ]; then
		subdir=$2
		shift 2
	fi
	: "${subdir:=$1}"
	lang="$1"
	shift
	vmkdir usr/share/hunspell
	vinstall "dictionaries/$subdir/$lang.aff" 0644 \
		usr/share/hunspell "$lang.aff"
	vinstall "dictionaries/$subdir/$lang.dic" 0644 \
		usr/share/hunspell "$lang.dic"
	_vbdic "$lang"
	for lnk; do
		ln -sf "$lang.aff" "${PKGDESTDIR}/usr/share/hunspell/$lnk.aff"
		ln -sf "$lang.dic" "${PKGDESTDIR}/usr/share/hunspell/$lnk.dic"
		_vbdiclink "$lang" "$lnk"
	done
}

_vhyphen() {
	local subdir lang lnk
	if [ "$1" = -d ]; then
		subdir=$2
		shift 2
	fi
	: "${subdir:=$1}"
	lang="$1"
	shift
	vmkdir usr/share/hyphen
	vinstall "dictionaries/$subdir/hyph_${lang}.dic" 0644 usr/share/hyphen
	for lnk; do
		ln -s "hyph_$lang.dic" \
			"${PKGDESTDIR}/usr/share/hyphen/hyph_$lnk.dic"
	done
}

_vmythes() {
	local subdir lang lnk
	local ver=
	if [ "$1" = -v ]; then ver="_v$2"; shift 2; fi
	if [ "$1" = -d ]; then
		subdir=$2
		shift 2
	fi
	: "${subdir:=$1}"
	lang="$1"
	shift
	vmkdir usr/share/mythes
	vinstall "dictionaries/$subdir/th_${lang}${ver}.dat" \
		0644 usr/share/mythes
	vinstall "dictionaries/$subdir/th_${lang}${ver}.idx" \
		0644 usr/share/mythes
	for lnk; do
		ln -s "th_$lang$ver.dat" \
			"${PKGDESTDIR}/usr/share/mythes/th_$lnk$ver.dat"
		ln -s "th_$lang$ver.idx" \
			"${PKGDESTDIR}/usr/share/mythes/th_$lnk$ver.idx"
	done
}

do_build() {
	local file

	if [ "$build_option_bdic" ]; then
		_build_bdic
	fi

	find dictionaries -name 'th_*.dat' |
	while read file; do
		th_gen_idx.pl <"$file" >"${file%.dat}.idx"
	done
}

post_patch() {
	mv dictionaries/be_BY/{be-official,be_BY}.aff
	mv dictionaries/be_BY/{be-official,be_BY}.dic
	mv dictionaries/ckb/dictionaries/ckb.{aff,dic} dictionaries/ckb/

	mv dictionaries/de/de_AT_frami.aff dictionaries/de/de_AT.aff
	mv dictionaries/de/de_AT_frami.dic dictionaries/de/de_AT.dic
	mv dictionaries/de/de_CH_frami.aff dictionaries/de/de_CH.aff
	mv dictionaries/de/de_CH_frami.dic dictionaries/de/de_CH.dic
	mv dictionaries/de/de_DE_frami.aff dictionaries/de/de_DE.aff
	mv dictionaries/de/de_DE_frami.dic dictionaries/de/de_DE.dic

	mv dictionaries/fa_IR/{fa-IR,fa_IR}.aff
	mv dictionaries/fa_IR/{fa-IR,fa_IR}.dic

	mv dictionaries/cs_CZ/{thes,th}_cs_CZ.dat
	mv dictionaries/gl/{thesaurus,th}_gl.dat
	mv dictionaries/ru_RU/th_ru_RU{_M_aot_and,}_v2.dat
	mv dictionaries/fr_FR/{thes,th}_fr.dat
}

do_install() {
	:
}

# pkgname is:
# - if unavailable: only language; break
# - if lower version: keep old name; break
# - use only language, provides and replaces

hunspell-en_package() {
	short_desc="English dictionary for hunspell"
	license="custom:SCOWL, LGPL-2.1-or-later"
	provides="hunspell-en_US-2024_1"
	replaces="hunspell-en_US>=0"
	pkg_install() {
		_vhunspell -d en en_US
		vlicense dictionaries/en/README_en_US.txt
	}
}

hyphen-en_package() {
	short_desc="English hyphenation rules"
	license="custom:SCOWL"
	pkg_install() {
		_vhyphen -d en en_US
		vlicense dictionaries/en/WordNet_license.txt
	}
}

mythes-en_package() {
	short_desc="English thesaurus for LibreOffice"
	license="MIT"
	pkg_install() {
		_vmythes -v 2 -d en en_US
		vlicense dictionaries/en/WordNet_license.txt
	}
}

hunspell-no_package() {
	short_desc="Norwegian (Nynorsk and Bokmål) dictionary for hunspell"
	license="GPL-2.0-or-later"
	pkg_install() {
		_vhunspell -d no nb_NO
	}
}

hyphen-no_package() {
	short_desc="Norwegian (Nynorsk and Bokmål) hyphenation rules"
	license="GPL-2.0-or-later"
	pkg_install() {
		_vhyphen -d no nb_NO
	}
}

mythes-no_package() {
	short_desc="Norwegian (Nynorsk and Bokmål) thesaurus for LibreOffice"
	license="GPL-2.0-or-later"
	pkg_install() {
		_vmythes -v 2 -d no nb_NO
	}
}

